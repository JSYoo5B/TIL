# 멀티태스크

## 멀티태스크

### 지킬박사와 하이드

컨텍스트 스위치: 어떤 프로세스에서 다른 프로세스로 실행을 전환하는 것

멀티태스크 실행환경: 어떤 실행 환경이 멀티태스크 가능하다 == 임의의 시점에서 새로운 프로세스를 생성할 수 있고, 계산 도중 상태에 있는 프로세스가 공평하게 실행된다.

약한 공평성: 언젠가 실행은 될 거지만, 우선순위 스케쥴링에서 계속 우선순위가 낮은 상태라면 실행할 기회가 안 온다.  
강한 공평성: 언젠가 실행은 될 거고, 우선순위 스케쥴링에서 우선순위가 제일 낮아도 기회가 온다.

### 협조적/비협조적 멀티태스크

프로세스가 자발적으로 컨텍스트 스위치를 수행하면 협조적  
프로세스 협조 없이 외부적인 작동에 따라 컨택스트 스위치를 하면 비협조적

협조적이라 함은

1. 알아서 적당히 프로세스가 다음 실행 시간을 넘겨줄 수 있어야 하고
2. 이 때 다른 프로세스로 컨텍스트 스위치를 해 줘야 하고 (내 문맥 양보)
3. 다른 프로세스에서 내 차례로 올 때도 컨텍스트 스위치를 해줘야 한다 (내 문맥 복원)

이에 따라, 임의로 프로세스와의 협의 없이 강제로 수행하는 것을 선점이라 한다.

협조적 멀티태스킹의 대표적 예시는 이전에 다룬 async/await 등이 있다.  
기초적인 Windows Programming의 Event-Driven도 비슷한 방식이다.  
협조적 멀티태스킹은 알아서 잘 멀티태스킹을 제공해야 하고, 한 프로세스의 동작이 최소 프로세스에서 시작해서 최대 OS까지(협조적 멀티태스킹만 제공하는 OS) 장애로 이어질 수 있다.

반면 비협조적인 경우 임의로 스케쥴러에 의해 선점되어 다른 프로세스가 실행되기 때문에 잘못 작성한 프로세스가 OS까지 문제를 일으키지 않는 편이다.

선점형, 비협조적 멀티태스킹 환경에서는 태스크가 공유 자원을 점유한 상태로 중단되고, 다른 태스크가 동일 자원을 요청하는 상황이 발생할 수 있어 교착 상태 발생 가능성이 더 높다. (협조적 멀티태스킹이 단일 프로세서에서 실행되고, 컨택스트 스위치 전에 공유자원을 반납한다면 발생하지 않는다.)  
범용 OS에서는 자원 점유에 대해 일반적으로 비선점적으로 동작하며, 점유한 태스크만 해당 자원을 해제할 수 있도록 설계되어 있다.  
참고로, 실시간 운영체제(RTOS)에서는 데드락 회피와 deadline 보장을 위해 우선순위 조정, lock timeout, 빠른 자원 반납 유도 등의 정책을 제공하기도 한다.

## 협조적 그린 스레드 구현

스케쥴링을 유저랜드에서 구현해야하기 때문에 아래 내용을 구현한다.

* 컨택스트 스위칭을 하는 과정 (SET_CONTEXT)  
  AAPCS64에 맞게 레지스터를 메모리에 저장한다.
* 컨택스트를 변경하는 과정 (SWITCH_CONTEXT)  
  AAPCS64에 맞게 저장한 메모리에서 레지스터로 가져온다.
* 스레드들을 관리하기 위해 컨텍스트들을 큐로 관리한다.

## 액터 모델 구현

그린 스레드끼리 서로 메시지를 교환하는 동시 계산 모델

각 액터는 완전 멀티스레드로 돌아가는 것 처럼 코드를 작성하고, 서로 협력을 위해 메시지를 교환할 수 있는 구조로 잡는다.

스케쥴링 스레드 큐 처럼 메시지 큐를 만들고, 메시지 큐 수신 내역이 대기 스레드 순서와 일치하면 실행 큐로 옮기는 과정이 포함되어있다.
